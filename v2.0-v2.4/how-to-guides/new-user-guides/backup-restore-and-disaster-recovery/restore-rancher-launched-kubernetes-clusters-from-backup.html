<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-2.0-2.4 plugin-docs plugin-id-default docs-doc-id-how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Rancher Manager" href="/opensearch.xml"><title data-rh="true">Restoring Backups—Kubernetes installs | Rancher Manager</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://docs.ranchermanager.rancher.io//v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="2.0-2.4"><meta data-rh="true" name="docusaurus_tag" content="docs-default-2.0-2.4"><meta data-rh="true" name="docsearch:version" content="2.0-2.4"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-2.0-2.4"><meta data-rh="true" property="og:title" content="Restoring Backups—Kubernetes installs | Rancher Manager"><meta data-rh="true" name="description" content="This procedure describes how to use RKE to restore a snapshot of the Rancher Kubernetes cluster."><meta data-rh="true" property="og:description" content="This procedure describes how to use RKE to restore a snapshot of the Rancher Kubernetes cluster."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="http://docs.ranchermanager.rancher.io//v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup"><link data-rh="true" rel="alternate" href="http://docs.ranchermanager.rancher.io//v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup" hreflang="en"><link data-rh="true" rel="alternate" href="http://docs.ranchermanager.rancher.io//v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://30NEY6C9UY-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.9543bcfd.css">
<link rel="preload" href="/assets/js/runtime~main.217a7f9f.js" as="script">
<link rel="preload" href="/assets/js/main.00d8b9dc.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/rancher-logo-horiz-color.svg" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/rancher-logo-horiz-color.svg" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/v2.0-v2.4">v2.0-v2.4</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup">v2.6</a></li><li><a class="dropdown__link" href="/v2.5/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup">v2.5</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup">v2.0-v2.4</a></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__docs navbar__link--active" href="/v2.0-v2.4">Docs</a><a href="https://github.com/rancher/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v2.0-v2.4">Rancher 2.0-2.4</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/v2.0-v2.4/getting-started">Getting Started</a><button aria-label="Toggle the collapsible sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/v2.0-v2.4/how-to-guides">How-to Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;How-to Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/v2.0-v2.4/pages-for-subheaders/new-user-guides">New User Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;New User Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.0-v2.4/pages-for-subheaders/kubernetes-cluster-setup">Kubernetes Cluster Setup</a><button aria-label="Toggle the collapsible sidebar category &#x27;Kubernetes Cluster Setup&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.0-v2.4/pages-for-subheaders/infrastructure-setup">Infrastructure Setup</a><button aria-label="Toggle the collapsible sidebar category &#x27;Infrastructure Setup&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.0-v2.4/pages-for-subheaders/kubernetes-clusters-in-rancher-setup">Kubernetes Clusters in Rancher Setup</a><button aria-label="Toggle the collapsible sidebar category &#x27;Kubernetes Clusters in Rancher Setup&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.0-v2.4/pages-for-subheaders/kubernetes-resources-setup">Kubernetes Resources Setup</a><button aria-label="Toggle the collapsible sidebar category &#x27;Kubernetes Resources Setup&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.0-v2.4/pages-for-subheaders/helm-charts-in-rancher">Helm Charts in Rancher</a><button aria-label="Toggle the collapsible sidebar category &#x27;Helm Charts in Rancher&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.0-v2.4/how-to-guides/new-user-guides/deploy-apps-across-clusters">Deploying Applications across Clusters</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/v2.0-v2.4/pages-for-subheaders/backup-restore-and-disaster-recovery">Backup, Restore, and Disaster Recovery</a><button aria-label="Toggle the collapsible sidebar category &#x27;Backup, Restore, and Disaster Recovery&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/back-up-docker-installed-rancher">Backing up Rancher Installed with Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-docker-installed-rancher">Restoring Backups—Docker Installs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/back-up-k3s-installed-rancher">Backing up Rancher Installed on a K3s Kubernetes Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-k3s-installed-rancher">Restoring Rancher Installed on a K3s Kubernetes Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/back-up-rancher-launched-kubernetes-clusters">Backing up Rancher Installed on an RKE Kubernetes Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup">Restoring Backups—Kubernetes installs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup/roll-back-to-v2.0-v2.1">Rolling back to v2.0.0-v2.1.5</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.0-v2.4/pages-for-subheaders/migrate-from-v1.6-v2.x">Migrating from v1.6 to v2.x</a><button aria-label="Toggle the collapsible sidebar category &#x27;Migrating from v1.6 to v2.x&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.0-v2.4/pages-for-subheaders/advanced-user-guides">Advanced User Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Advanced User Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/v2.0-v2.4/reference-guides">Reference Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/v2.0-v2.4/explanations">Explanations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Explanations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/v2.0-v2.4/faq">FAQ</a><button aria-label="Toggle the collapsible sidebar category &#x27;FAQ&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/v2.0-v2.4/troubleshooting">Troubleshooting</a><button aria-label="Toggle the collapsible sidebar category &#x27;Troubleshooting&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v2.0-v2.4/contribute-to-rancher">Contributing to Rancher</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Rancher Manager<!-- --> <b>v2.0-v2.4</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup">latest version</a></b> (<!-- -->v2.6<!-- -->).</div></div><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/v2.0-v2.4/how-to-guides"><span itemprop="name">How-to Guides</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/v2.0-v2.4/pages-for-subheaders/new-user-guides"><span itemprop="name">New User Guides</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/v2.0-v2.4/pages-for-subheaders/backup-restore-and-disaster-recovery"><span itemprop="name">Backup, Restore, and Disaster Recovery</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Restoring Backups—Kubernetes installs</span><meta itemprop="position" content="4"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v2.0-v2.4</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Restoring Backups—Kubernetes installs</h1></header><p>This procedure describes how to use RKE to restore a snapshot of the Rancher Kubernetes cluster.
This will restore the Kubernetes configuration and the Rancher database and state.</p><blockquote><p><strong>Note:</strong> This document covers clusters set up with RKE &gt;= v0.2.x, for older RKE versions refer to the <a href="https://rancher.com/docs/rke/latest/en/etcd-snapshots/restoring-from-backup" target="_blank" rel="noopener noreferrer">RKE Documentation</a>.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="restore-outline">Restore Outline<a class="hash-link" href="#restore-outline" title="Direct link to heading">​</a></h2><ul><li><a href="#1-preparation">1. Preparation</a></li><li><a href="#2-place-snapshot">2. Place Snapshot</a></li><li><a href="#3-configure-rke">3. Configure RKE</a></li><li><a href="#4-restore-the-database-and-bring-up-the-cluster">4. Restore the Database and bring up the Cluster</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-preparation">1. Preparation<a class="hash-link" href="#1-preparation" title="Direct link to heading">​</a></h3><p>It is advised that you run the restore from your local host or a jump box/bastion where your cluster yaml, rke statefile, and kubeconfig are stored.  You will need <a href="https://rancher.com/docs/rke/latest/en/installation/" target="_blank" rel="noopener noreferrer">RKE</a> and <a href="/v2.0-v2.4/faq/install-and-configure-kubectl">kubectl</a> CLI utilities installed locally.</p><p>Prepare by creating 3 new nodes to be the target for the restored Rancher instance.  We recommend that you start with fresh nodes and a clean state. For clarification on the requirements, review the <a href="https://rancher.com/docs/rancher/v2.0-v2.4/en/installation/requirements/" target="_blank" rel="noopener noreferrer">Installation Requirements</a>.</p><p>Alternatively you can re-use the existing nodes after clearing Kubernetes and Rancher configurations. This will destroy the data on these nodes. See <a href="/v2.0-v2.4/how-to-guides/advanced-user-guides/manage-clusters/clean-cluster-nodes">Node Cleanup</a> for the procedure.</p><p>You must restore each of your etcd nodes to the same snapshot. Copy the snapshot you&#x27;re using from one of your nodes to the others before running the <code>etcd snapshot-restore</code> command.</p><blockquote><p><strong>IMPORTANT:</strong> Before starting the restore make sure all the Kubernetes services on the old cluster nodes are stopped. We recommend powering off the nodes to be sure.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-place-snapshot">2. Place Snapshot<a class="hash-link" href="#2-place-snapshot" title="Direct link to heading">​</a></h3><p>As of RKE v0.2.0, snapshots could be saved in an S3 compatible backend. To restore your cluster from the snapshot stored in S3 compatible backend, you can skip this step and retrieve the snapshot in <a href="#4-restore-the-database-and-bring-up-the-cluster">4. Restore the Database and bring up the Cluster</a>. Otherwise, you will need to place the snapshot directly on one of the etcd nodes.</p><p>Pick one of the clean nodes that will have the etcd role assigned and place the zip-compressed snapshot file in <code>/opt/rke/etcd-snapshots</code> on that node.</p><blockquote><p><strong>Note:</strong> Because of a current limitation in RKE, the restore process does not work correctly if <code>/opt/rke/etcd-snapshots</code> is a NFS share that is mounted on all nodes with the etcd role. The easiest options are to either keep <code>/opt/rke/etcd-snapshots</code> as a local folder during the restore process and only mount the NFS share there after it has been completed, or to only mount the NFS share to one node with an etcd role in the beginning.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-configure-rke">3. Configure RKE<a class="hash-link" href="#3-configure-rke" title="Direct link to heading">​</a></h3><p>Use your original <code>rancher-cluster.yml</code> and <code>rancher-cluster.rkestate</code> files. If they are not stored in a version control system, it is a good idea to back them up before making any changes.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cp rancher-cluster.yml rancher-cluster.yml.bak</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cp rancher-cluster.rkestate rancher-cluster.rkestate.bak</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the replaced or cleaned nodes have been configured with new IP addresses, modify the <code>rancher-cluster.yml</code> file to ensure the address and optional internal_address fields reflect the new addresses.</p><blockquote><p><strong>IMPORTANT:</strong> You should not rename the <code>rancher-cluster.yml</code> or <code>rancher-cluster.rkestate</code> files. It is important that the filenames match each other.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-restore-the-database-and-bring-up-the-cluster">4. Restore the Database and bring up the Cluster<a class="hash-link" href="#4-restore-the-database-and-bring-up-the-cluster" title="Direct link to heading">​</a></h3><p>You will now use the RKE command-line tool with the <code>rancher-cluster.yml</code> and the <code>rancher-cluster.rkestate</code> configuration files to restore the etcd database and bring up the cluster on the new nodes.</p><blockquote><p><strong>Note:</strong> Ensure your <code>rancher-cluster.rkestate</code> is present in the same directory as the <code>rancher-cluster.yml</code> file before starting the restore, as this file contains the certificate data for the cluster.</p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="restoring-from-a-local-snapshot">Restoring from a Local Snapshot<a class="hash-link" href="#restoring-from-a-local-snapshot" title="Direct link to heading">​</a></h4><p>When restoring etcd from a local snapshot, the snapshot is assumed to be located on the target node in the directory <code>/opt/rke/etcd-snapshots</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">rke etcd snapshot-restore --name snapshot-name --config ./rancher-cluster.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p><strong>Note:</strong> The --name parameter expects the filename of the snapshot without the extension.</p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="restoring-from-a-snapshot-in-s3">Restoring from a Snapshot in S3<a class="hash-link" href="#restoring-from-a-snapshot-in-s3" title="Direct link to heading">​</a></h4><p><em>Available as of RKE v0.2.0</em></p><p>When restoring etcd from a snapshot located in an S3 compatible backend, the command needs the S3 information in order to connect to the S3 backend and retrieve the snapshot.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ rke etcd snapshot-restore --config ./rancher-cluster.yml --name snapshot-name \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--s3 --access-key S3_ACCESS_KEY --secret-key S3_SECRET_KEY \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--bucket-name s3-bucket-name --s3-endpoint s3.amazonaws.com \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--folder folder-name # Available as of v2.3.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="options-for-rke-etcd-snapshot-restore">Options for <code>rke etcd snapshot-restore</code><a class="hash-link" href="#options-for-rke-etcd-snapshot-restore" title="Direct link to heading">​</a></h4><p>S3 specific options are only available for RKE v0.2.0+.</p><table><thead><tr><th>Option</th><th>Description</th><th>S3 Specific</th></tr></thead><tbody><tr><td><code>--name</code> value</td><td>Specify snapshot name</td><td></td></tr><tr><td><code>--config</code> value</td><td>Specify an alternate cluster YAML file (default: &quot;cluster.yml&quot;) <!-- -->[$RKE_CONFIG]</td><td></td></tr><tr><td><code>--s3</code></td><td>Enabled backup to s3</td><td>*</td></tr><tr><td><code>--s3-endpoint</code> value</td><td>Specify s3 endpoint url (default: &quot;s3.amazonaws.com&quot;)</td><td>*</td></tr><tr><td><code>--access-key</code> value</td><td>Specify s3 accessKey</td><td>*</td></tr><tr><td><code>--secret-key</code> value</td><td>Specify s3 secretKey</td><td>*</td></tr><tr><td><code>--bucket-name</code> value</td><td>Specify s3 bucket name</td><td>*</td></tr><tr><td><code>--folder</code> value</td><td>Specify s3 folder in the bucket name <em>Available as of v2.3.0</em></td><td>*</td></tr><tr><td><code>--region</code> value</td><td>Specify the s3 bucket location (optional)</td><td>*</td></tr><tr><td><code>--ssh-agent-auth</code></td><td><a href="https://rancher.com/docs/rke/latest/en/config-options/#ssh-agent" target="_blank" rel="noopener noreferrer">Use SSH Agent Auth defined by SSH_AUTH_SOCK</a></td><td></td></tr><tr><td><code>--ignore-docker-version</code></td><td><a href="https://rancher.com/docs/rke/latest/en/config-options/#supported-docker-versions" target="_blank" rel="noopener noreferrer">Disable Docker version check</a></td><td></td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="testing-the-cluster">Testing the Cluster<a class="hash-link" href="#testing-the-cluster" title="Direct link to heading">​</a></h4><p>Once RKE completes it will have created a credentials file in the local directory.  Configure <code>kubectl</code> to use the <code>kube_config_rancher-cluster.yml</code> credentials file and check on the state of the cluster. See <a href="/v2.0-v2.4/faq/install-and-configure-kubectl#configuration">Installing and Configuring kubectl</a> for details.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="check-kubernetes-pods">Check Kubernetes Pods<a class="hash-link" href="#check-kubernetes-pods" title="Direct link to heading">​</a></h4><p>Wait for the pods running in <code>kube-system</code>, <code>ingress-nginx</code> and the <code>rancher</code> pod in <code>cattle-system</code> to return to the <code>Running</code> state.</p><blockquote><p><strong>Note:</strong> <code>cattle-cluster-agent</code> and <code>cattle-node-agent</code> pods will be in an <code>Error</code> or <code>CrashLoopBackOff</code> state until Rancher server is up and the DNS/Load Balancer have been pointed at the new cluster.</p></blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get pods --all-namespaces</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NAMESPACE       NAME                                    READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cattle-system   cattle-cluster-agent-766585f6b-kj88m    0/1       Error     6          4m</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cattle-system   cattle-node-agent-wvhqm                 0/1       Error     8          8m</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cattle-system   rancher-78947c8548-jzlsr                0/1       Running   1          4m</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ingress-nginx   default-http-backend-797c5bc547-f5ztd   1/1       Running   1          4m</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ingress-nginx   nginx-ingress-controller-ljvkf          1/1       Running   1          8m</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system     canal-4pf9v                             3/3       Running   3          8m</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system     cert-manager-6b47fc5fc-jnrl5            1/1       Running   1          4m</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system     kube-dns-7588d5b5f5-kgskt               3/3       Running   3          4m</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system     kube-dns-autoscaler-5db9bbb766-s698d    1/1       Running   1          4m</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system     metrics-server-97bc649d5-6w7zc          1/1       Running   1          4m</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system     tiller-deploy-56c4cf647b-j4whh          1/1       Running   1          4m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="finishing-up">Finishing Up<a class="hash-link" href="#finishing-up" title="Direct link to heading">​</a></h4><p>Rancher should now be running and available to manage your Kubernetes clusters.</p><blockquote><p><strong>IMPORTANT:</strong> Remember to save your updated RKE config (<code>rancher-cluster.yml</code>) state file (<code>rancher-cluster.rkestate</code>) and <code>kubectl</code> credentials (<code>kube_config_rancher-cluster.yml</code>) files in a safe place for future maintenance for example in a version control system.</p></blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/rancher/rancher-docs/edit/main/versioned_docs/version-2.0-2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-09-08T22:35:34.000Z">9/8/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/back-up-rancher-launched-kubernetes-clusters"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Backing up Rancher Installed on an RKE Kubernetes Cluster</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/v2.0-v2.4/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher-launched-kubernetes-clusters-from-backup/roll-back-to-v2.0-v2.1"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Rolling back to v2.0.0-v2.1.5</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#restore-outline" class="table-of-contents__link toc-highlight">Restore Outline</a><ul><li><a href="#1-preparation" class="table-of-contents__link toc-highlight">1. Preparation</a></li><li><a href="#2-place-snapshot" class="table-of-contents__link toc-highlight">2. Place Snapshot</a></li><li><a href="#3-configure-rke" class="table-of-contents__link toc-highlight">3. Configure RKE</a></li><li><a href="#4-restore-the-database-and-bring-up-the-cluster" class="table-of-contents__link toc-highlight">4. Restore the Database and bring up the Cluster</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 SUSE Rancher. All Rights Reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.217a7f9f.js"></script>
<script src="/assets/js/main.00d8b9dc.js"></script>
</body>
</html>