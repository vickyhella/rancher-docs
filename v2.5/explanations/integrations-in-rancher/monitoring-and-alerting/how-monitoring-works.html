<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-2.5 plugin-docs plugin-id-default docs-doc-id-explanations/integrations-in-rancher/monitoring-and-alerting/how-monitoring-works">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Rancher Manager" href="/opensearch.xml"><title data-rh="true">How Monitoring Works | Rancher Manager</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://docs.ranchermanager.rancher.io//v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/how-monitoring-works"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="2.5"><meta data-rh="true" name="docusaurus_tag" content="docs-default-2.5"><meta data-rh="true" name="docsearch:version" content="2.5"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-2.5"><meta data-rh="true" property="og:title" content="How Monitoring Works | Rancher Manager"><meta data-rh="true" name="description" content="1. Architecture Overview"><meta data-rh="true" property="og:description" content="1. Architecture Overview"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="http://docs.ranchermanager.rancher.io//v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/how-monitoring-works"><link data-rh="true" rel="alternate" href="http://docs.ranchermanager.rancher.io//v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/how-monitoring-works" hreflang="en"><link data-rh="true" rel="alternate" href="http://docs.ranchermanager.rancher.io//v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/how-monitoring-works" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://30NEY6C9UY-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.31d3122a.css">
<link rel="preload" href="/assets/js/runtime~main.d2604d48.js" as="script">
<link rel="preload" href="/assets/js/main.aa78001f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/rancher-logo-horiz-color.svg" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/rancher-logo-horiz-color.svg" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/v2.5">v2.5</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/explanations/integrations-in-rancher/monitoring-and-alerting/how-monitoring-works">v2.6</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/how-monitoring-works">v2.5</a></li><li><a class="dropdown__link" href="/v2.0-v2.4">v2.0-v2.4</a></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__docs navbar__link--active" href="/v2.5">Docs</a><a href="https://github.com/rancher/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v2.5">Rancher 2.5</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/v2.5/getting-started">Getting Started</a><button aria-label="Toggle the collapsible sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/v2.5/how-to-guides">How-to Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;How-to Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/v2.5/reference-guides">Reference Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/v2.5/explanations">Explanations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Explanations&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/v2.5/pages-for-subheaders/integrations-in-rancher">Integrations in Rancher</a><button aria-label="Toggle the collapsible sidebar category &#x27;Integrations in Rancher&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.5/pages-for-subheaders/cis-scans">CIS Scans</a><button aria-label="Toggle the collapsible sidebar category &#x27;CIS Scans&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.5/pages-for-subheaders/fleet-gitops-at-scale">Fleet - GitOps at Scale</a><button aria-label="Toggle the collapsible sidebar category &#x27;Fleet - GitOps at Scale&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.5/pages-for-subheaders/istio">Istio</a><button aria-label="Toggle the collapsible sidebar category &#x27;Istio&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.5/explanations/integrations-in-rancher/longhorn">Longhorn - Cloud native distributed block storage for Kubernetes</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/v2.5/pages-for-subheaders/logging">Logging</a><button aria-label="Toggle the collapsible sidebar category &#x27;Logging&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/v2.5/pages-for-subheaders/monitoring-and-alerting">Monitoring and Alerting</a><button aria-label="Toggle the collapsible sidebar category &#x27;Monitoring and Alerting&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/how-monitoring-works">How Monitoring Works</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/rbac-for-monitoring">Role-based Access Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/built-in-dashboards">Built-in Dashboards</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/windows-support">Windows Cluster Support for Monitoring V2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/promql-expressions">PromQL Expression Reference</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/v2.5/explanations/integrations-in-rancher/opa-gatekeeper">OPA Gatekeeper</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/v2.5/faq">FAQ</a><button aria-label="Toggle the collapsible sidebar category &#x27;FAQ&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/v2.5/troubleshooting">Troubleshooting</a><button aria-label="Toggle the collapsible sidebar category &#x27;Troubleshooting&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v2.5/contribute-to-rancher">Contributing to Rancher</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Rancher Manager<!-- --> <b>v2.5</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/explanations/integrations-in-rancher/monitoring-and-alerting/how-monitoring-works">latest version</a></b> (<!-- -->v2.6<!-- -->).</div></div><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/v2.5/explanations"><span itemprop="name">Explanations</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/v2.5/pages-for-subheaders/integrations-in-rancher"><span itemprop="name">Integrations in Rancher</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/v2.5/pages-for-subheaders/monitoring-and-alerting"><span itemprop="name">Monitoring and Alerting</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">How Monitoring Works</span><meta itemprop="position" content="4"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v2.5</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>How Monitoring Works</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-architecture-overview">1. Architecture Overview<a class="hash-link" href="#1-architecture-overview" title="Direct link to heading">​</a></h2><p><em><strong>The following sections describe how data flows through the Monitoring V2 application:</strong></em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus-operator">Prometheus Operator<a class="hash-link" href="#prometheus-operator" title="Direct link to heading">​</a></h3><p>Prometheus Operator observes ServiceMonitors, PodMonitors, and PrometheusRules being created. When the Prometheus configuration resources are created, Prometheus Operator calls the Prometheus API to sync the new configuration. As the diagram at the end of this section shows, the Prometheus Operator acts as the intermediary between Prometheus and Kubernetes, calling the Prometheus API to synchronize Prometheus with the monitoring-related resources in Kubernetes.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="servicemonitors-and-podmonitors">ServiceMonitors and PodMonitors<a class="hash-link" href="#servicemonitors-and-podmonitors" title="Direct link to heading">​</a></h3><p>ServiceMonitors and PodMonitors declaratively specify targets, such as Services and Pods, that need to be monitored.</p><ul><li><p>Targets are scraped on a recurring schedule based on the configured Prometheus scrape interval, and the metrics that are scraped are stored into the Prometheus Time Series Database (TSDB).</p></li><li><p>In order to perform the scrape, ServiceMonitors and PodMonitors are defined with label selectors that determine which Services or Pods should be scraped and endpoints that determine how the scrape should happen on the given target, e.g., scrape/metrics in TCP 10252, proxying through IP addr x.x.x.x.</p></li><li><p>Out of the box, Monitoring V2 comes with certain pre-configured exporters that are deployed based on the type of Kubernetes cluster that it is deployed on. For more information, see <a href="#5-scraping-and-exposing-metrics">Scraping and Exposing Metrics</a>.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-pushprox-works">How PushProx Works<a class="hash-link" href="#how-pushprox-works" title="Direct link to heading">​</a></h3><ul><li><p>Certain internal Kubernetes components are scraped via a proxy deployed as part of Monitoring V2 called <strong>PushProx</strong>. The Kubernetes components that expose metrics to Prometheus through PushProx are the following:
<code>kube-controller-manager</code>, <code>kube-scheduler</code>, <code>etcd</code>, and <code>kube-proxy</code>.</p></li><li><p>For each PushProx exporter, we deploy one PushProx client onto all target nodes. For example, a PushProx client is deployed onto all controlplane nodes for kube-controller-manager, all etcd nodes for kube-etcd, and all nodes for kubelet.</p></li><li><p>We deploy exactly one PushProx proxy per exporter. The process for exporting metrics is as follows:</p></li></ul><ol><li>The PushProx Client establishes an outbound connection with the PushProx Proxy.</li><li>The client then polls the proxy for scrape requests that have come into the proxy.</li><li>When the proxy receives a scrape request from Prometheus, the client sees it as a result of the poll.</li><li>The client scrapes the internal component.</li><li>The internal component responds by pushing metrics back to the proxy.</li></ol><figcaption><br>Process for Exporting Metrics with PushProx:<br></figcaption><p><img loading="lazy" alt="Process for Exporting Metrics with PushProx" src="/assets/images/pushprox-process-55d88db60b9b3bc052a693a41774df74.svg" width="821" height="612" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prometheusrules">PrometheusRules<a class="hash-link" href="#prometheusrules" title="Direct link to heading">​</a></h3><p>PrometheusRules allow users to define rules for what metrics or time series database queries should result in alerts being fired. Rules are evaluated on an interval.</p><ul><li><strong>Recording rules</strong> create a new time series based on existing series that have been collected. They are frequently used to precompute complex queries.</li><li><strong>Alerting rules</strong> run a particular query and fire an alert from Prometheus if the query evaluates to a non-zero value.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="alert-routing">Alert Routing<a class="hash-link" href="#alert-routing" title="Direct link to heading">​</a></h3><p>Once Prometheus determines that an alert needs to be fired, alerts are forwarded to <strong>Alertmanager</strong>.</p><ul><li><p>Alerts contain labels that come from the PromQL query itself and additional labels and annotations that can be provided as part of specifying the initial PrometheusRule.</p></li><li><p>Before receiving any alerts, Alertmanager will use the <strong>routes</strong> and <strong>receivers</strong> specified in its configuration to form a routing tree on which all incoming alerts are evaluated. Each node of the routing tree can specify additional grouping, labeling, and filtering that needs to happen based on the labels attached to the Prometheus alert. A node on the routing tree (usually a leaf node) can also specify that an alert that reaches it needs to be sent out to a configured Receiver, e.g., Slack, PagerDuty, SMS, etc. Note that Alertmanager will send an alert first to <strong>alertingDriver</strong>, then alertingDriver will send or forward alert to the proper destination.</p></li><li><p>Routes and receivers are also stored in the Kubernetes API via the Alertmanager Secret. When the Secret is updated, Alertmanager is also updated automatically. Note that routing occurs via labels only (not via annotations, etc.).</p></li></ul><figcaption>How data flows through the monitoring application:</figcaption><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-how-prometheus-works">2. How Prometheus Works<a class="hash-link" href="#2-how-prometheus-works" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="storing-time-series-data">Storing Time Series Data<a class="hash-link" href="#storing-time-series-data" title="Direct link to heading">​</a></h3><p>After collecting metrics from exporters, Prometheus stores the time series in a local on-disk time series database. Prometheus optionally integrates with remote systems, but <code>rancher-monitoring</code> uses local storage for the time series database.</p><p>Once stored, users can query this TSDB using PromQL, the query language for Prometheus.</p><p>PromQL queries can be visualized in one of two ways:</p><ol><li>By supplying the query in Prometheus&#x27;s Graph UI, which will show a simple graphical view of the data.</li><li>By creating a Grafana Dashboard that contains the PromQL query and additional formatting directives that label axes, add units, change colors, use alternative visualizations, etc.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="defining-rules-for-prometheus">Defining Rules for Prometheus<a class="hash-link" href="#defining-rules-for-prometheus" title="Direct link to heading">​</a></h3><p>Rules define queries that Prometheus needs to execute on a regular <code>evaluationInterval</code> to perform certain actions, such as firing an alert (alerting rules) or precomputing a query based on others existing in its TSDB (recording rules). These rules are encoded in PrometheusRules custom resources. When PrometheusRule custom resources are created or updated, the Prometheus Operator observes the change and calls the Prometheus API to synchronize the set of rules that Prometheus is currently evaluating on a regular interval.</p><p>A PrometheusRule allows you to define one or more RuleGroups. Each RuleGroup consists of a set of Rule objects that can each represent either an alerting or a recording rule with the following fields:</p><ul><li>The name of the new alert or record</li><li>A PromQL expression for the new alert or record</li><li>Labels that should be attached to the alert or record that identify it (e.g. cluster name or severity)</li><li>Annotations that encode any additional important pieces of information that need to be displayed on the notification for an alert (e.g. summary, description, message, runbook URL, etc.). This field is not required for recording rules.</li></ul><p>On evaluating a <a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#rule" target="_blank" rel="noopener noreferrer">rule</a>, Prometheus will execute the provided PromQL query, add additional provided labels (or annotations - only for alerting rules), and execute the appropriate action for the rule. For example, an Alerting Rule that adds <code>team: front-end</code> as a label to the provided PromQL query will append that label to the fired alert, which will allow Alertmanager to forward the alert to the correct Receiver.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="alerting-and-recording-rules">Alerting and Recording Rules<a class="hash-link" href="#alerting-and-recording-rules" title="Direct link to heading">​</a></h3><p>Prometheus doesn&#x27;t maintain the state of whether alerts are active. It fires alerts repetitively at every evaluation interval, relying on Alertmanager to group and filter the alerts into meaningful notifications.</p><p>The <code>evaluation_interval</code> constant defines how often Prometheus evaluates its alerting rules against the time series database. Similar to the <code>scrape_interval</code>, the <code>evaluation_interval</code> also defaults to one minute.</p><p>The rules are contained in a set of rule files. Rule files include both alerting rules and recording rules, but only alerting rules result in alerts being fired after their evaluation.</p><p>For recording rules, Prometheus runs a query, then stores it as a time series. This synthetic time series is useful for storing the results of an expensive or time-consuming query so that it can be queried more quickly in the future.</p><p>Alerting rules are more commonly used. Whenever an alerting rule evaluates to a positive number, Prometheus fires an alert.</p><p>The Rule file adds labels and annotations to alerts before firing them, depending on the use case:</p><ul><li><p>Labels indicate information that identifies the alert and could affect the routing of the alert. For example, if when sending an alert about a certain container, the container ID could be used as a label.</p></li><li><p>Annotations denote information that doesn&#x27;t affect where an alert is routed, for example, a runbook or an error message.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-how-alertmanager-works">3. How Alertmanager Works<a class="hash-link" href="#3-how-alertmanager-works" title="Direct link to heading">​</a></h2><p>The Alertmanager handles alerts sent by client applications such as the Prometheus server. It takes care of the following tasks:</p><ul><li><p>Deduplicating, grouping, and routing alerts to the correct receiver integration such as email, PagerDuty, or OpsGenie</p></li><li><p>Silencing and inhibition of alerts</p></li><li><p>Tracking alerts that fire over time</p></li><li><p>Sending out the status of whether an alert is currently firing, or if it is resolved</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="alerts-forwarded-by-alertingdrivers">Alerts Forwarded by alertingDrivers<a class="hash-link" href="#alerts-forwarded-by-alertingdrivers" title="Direct link to heading">​</a></h3><p>When alertingDrivers are installed, this creates a <code>Service</code> that can be used as the receiver&#x27;s URL for Teams or SMS, based on the alertingDriver&#x27;s configuration. The URL in the Receiver points to the alertingDrivers; so the Alertmanager sends alert first to alertingDriver, then alertingDriver forwards or sends alert to the proper destination.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="routing-alerts-to-receivers">Routing Alerts to Receivers<a class="hash-link" href="#routing-alerts-to-receivers" title="Direct link to heading">​</a></h3><p>Alertmanager coordinates where alerts are sent. It allows you to group alerts based on labels and fire them based on whether certain labels are matched. One top-level route accepts all alerts. From there, Alertmanager continues routing alerts to receivers based on whether they match the conditions of the next route.</p><p>While the Rancher UI forms only allow editing a routing tree that is two levels deep, you can configure more deeply nested routing structures by editing the Alertmanager Secret.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-multiple-receivers">Configuring Multiple Receivers<a class="hash-link" href="#configuring-multiple-receivers" title="Direct link to heading">​</a></h3><p>By editing the forms in the Rancher UI, you can set up a Receiver resource with all the information Alertmanager needs to send alerts to your notification system.</p><p>By editing custom YAML in the Alertmanager or Receiver configuration, you can also send alerts to multiple notification systems. For more information, see the section on configuring <a href="/v2.5/reference-guides/monitoring-v2-configuration/receivers#configuring-multiple-receivers">Receivers.</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-monitoring-v2-specific-components">4. Monitoring V2 Specific Components<a class="hash-link" href="#4-monitoring-v2-specific-components" title="Direct link to heading">​</a></h2><p>Prometheus Operator introduces a set of <a href="https://github.com/prometheus-operator/prometheus-operator#customresourcedefinitions" target="_blank" rel="noopener noreferrer">Custom Resource Definitions</a> that allow users to deploy and manage Prometheus and Alertmanager instances by creating and modifying those custom resources on a cluster.</p><p>Prometheus Operator will automatically update your Prometheus configuration based on the live state of the resources and configuration options that are edited in the Rancher UI.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="resources-deployed-by-default">Resources Deployed by Default<a class="hash-link" href="#resources-deployed-by-default" title="Direct link to heading">​</a></h3><p>By default, a set of resources curated by the <a href="https://github.com/prometheus-operator/kube-prometheus" target="_blank" rel="noopener noreferrer">kube-prometheus</a> project are deployed onto your cluster as part of installing the Rancher Monitoring Application to set up a basic Monitoring/Alerting stack.</p><p>The resources that get deployed onto your cluster to support this solution can be found in the <a href="https://github.com/rancher/charts/tree/main/charts/rancher-monitoring" target="_blank" rel="noopener noreferrer"><code>rancher-monitoring</code></a> Helm chart, which closely tracks the upstream <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack" target="_blank" rel="noopener noreferrer">kube-prometheus-stack</a> Helm chart maintained by the Prometheus community with certain changes tracked in the <a href="https://github.com/rancher/charts/blob/main/charts/rancher-monitoring/CHANGELOG.md" target="_blank" rel="noopener noreferrer">CHANGELOG.md</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="default-exporters">Default Exporters<a class="hash-link" href="#default-exporters" title="Direct link to heading">​</a></h3><p>Monitoring V2 deploys three default exporters that provide additional metrics for Prometheus to store:</p><ol><li><p><code>node-exporter</code>: exposes hardware and OS metrics for Linux hosts. For more information on <code>node-exporter</code>, refer to the <a href="https://prometheus.io/docs/guides/node-exporter/" target="_blank" rel="noopener noreferrer">upstream documentation</a>.</p></li><li><p><code>windows-exporter</code>: exposes hardware and OS metrics for Windows hosts (only deployed on Windows clusters). For more information on <code>windows-exporter</code>, refer to the <a href="https://github.com/prometheus-community/windows_exporter" target="_blank" rel="noopener noreferrer">upstream documentation</a>.</p></li><li><p><code>kube-state-metrics</code>: expose additional metrics that track the state of resources contained in the Kubernetes API (e.g., pods, workloads, etc.). For more information on <code>kube-state-metrics</code>, refer to the <a href="https://github.com/kubernetes/kube-state-metrics/tree/master/docs" target="_blank" rel="noopener noreferrer">upstream documentation</a>.</p></li></ol><p>ServiceMonitors and PodMonitors will scrape these exporters, as defined <a href="#defining-what-metrics-are-scraped">here</a>. Prometheus stores these metrics, and you can query the results via either Prometheus&#x27;s UI or Grafana.</p><p>See the <a href="#1-architecture-overview">architecture</a> section for more information on recording rules, alerting rules, and Alertmanager.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="components-exposed-in-the-rancher-ui">Components Exposed in the Rancher UI<a class="hash-link" href="#components-exposed-in-the-rancher-ui" title="Direct link to heading">​</a></h3><p>When the monitoring application is installed, you will be able to edit the following components in the Rancher UI:</p><table><thead><tr><th>Component</th><th>Type of Component</th><th>Purpose and Common Use Cases for Editing</th></tr></thead><tbody><tr><td>ServiceMonitor</td><td>Custom resource</td><td>Sets up Kubernetes Services to scrape custom metrics from. Automatically updates the scrape configuration in the Prometheus custom resource.</td></tr><tr><td>PodMonitor</td><td>Custom resource</td><td>Sets up Kubernetes Pods to scrape custom metrics from. Automatically updates the scrape configuration in the Prometheus custom resource.</td></tr><tr><td>Receiver</td><td>Configuration block (part of Alertmanager)</td><td>Modifies information on where to send an alert (e.g., Slack, PagerDuty, etc.) and any necessary information to send the alert (e.g., TLS certs, proxy URLs, etc.). Automatically updates the Alertmanager custom resource.</td></tr><tr><td>Route</td><td>Configuration block (part of Alertmanager)</td><td>Modifies the routing tree that is used to filter, label, and group alerts based on labels and send them to the appropriate Receiver. Automatically updates the Alertmanager custom resource.</td></tr><tr><td>PrometheusRule</td><td>Custom resource</td><td>Defines additional queries that need to trigger alerts or define materialized views of existing series that are within Prometheus&#x27;s TSDB.  Automatically updates the Prometheus custom resource.</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pushprox">PushProx<a class="hash-link" href="#pushprox" title="Direct link to heading">​</a></h3><p>PushProx allows Prometheus to scrape metrics across a network boundary, which prevents users from having to expose metrics ports for internal Kubernetes components on each node in a Kubernetes cluster.</p><p>Since the metrics for Kubernetes components are generally exposed on the host network of nodes in the cluster, PushProx deploys a DaemonSet of clients that sit on the hostNetwork of each node and make an outbound connection to a single proxy that is sitting on the Kubernetes API. Prometheus can then be configured to proxy scrape requests through the proxy to each client, which allows it to scrape metrics from the internal Kubernetes components without requiring any inbound node ports to be open.</p><p>Refer to <a href="#scraping-metrics-with-pushprox">Scraping Metrics with PushProx</a> for more.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-scraping-and-exposing-metrics">5. Scraping and Exposing Metrics<a class="hash-link" href="#5-scraping-and-exposing-metrics" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="defining-what-metrics-are-scraped">Defining what Metrics are Scraped<a class="hash-link" href="#defining-what-metrics-are-scraped" title="Direct link to heading">​</a></h3><p>ServiceMonitors and PodMonitors define targets that are intended for Prometheus to scrape. The <a href="https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/design.md#prometheus" target="_blank" rel="noopener noreferrer">Prometheus custom resource</a> tells Prometheus which ServiceMonitors or PodMonitors it should use to find out where to scrape metrics from.</p><p>The Prometheus Operator observes the ServiceMonitors and PodMonitors. When it observes that they are created or updated, it calls the Prometheus API to update the scrape configuration in the Prometheus custom resource and keep it in sync with the scrape configuration in the ServiceMonitors or PodMonitors. This scrape configuration tells Prometheus which endpoints to scrape metrics from and how it will label the metrics from those endpoints.</p><p>Prometheus scrapes all of the metrics defined in its scrape configuration at every <code>scrape_interval</code>, which is one minute by default.</p><p>The scrape configuration can be viewed as part of the Prometheus custom resource that is exposed in the Rancher UI.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-the-prometheus-operator-sets-up-metrics-scraping">How the Prometheus Operator Sets up Metrics Scraping<a class="hash-link" href="#how-the-prometheus-operator-sets-up-metrics-scraping" title="Direct link to heading">​</a></h3><p>The Prometheus Deployment or StatefulSet scrapes metrics, and the configuration of Prometheus is controlled by the Prometheus custom resources. The Prometheus Operator watches for Prometheus and Alertmanager resources, and when they are created, the Prometheus Operator creates a Deployment or StatefulSet for Prometheus or Alertmanager with the user-defined configuration.</p><p>When the Prometheus Operator observes ServiceMonitors, PodMonitors, and PrometheusRules being created, it knows that the scrape configuration needs to be updated in Prometheus. It updates Prometheus by first updating the configuration and rules files in the volumes of Prometheus&#x27;s Deployment or StatefulSet. Then it calls the Prometheus API to sync the new configuration, resulting in the Prometheus Deployment or StatefulSet to be modified in place.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-kubernetes-component-metrics-are-exposed">How Kubernetes Component Metrics are Exposed<a class="hash-link" href="#how-kubernetes-component-metrics-are-exposed" title="Direct link to heading">​</a></h3><p>Prometheus scrapes metrics from deployments known as <a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank" rel="noopener noreferrer">exporters,</a> which export the time series data in a format that Prometheus can ingest. In Prometheus, time series consist of streams of timestamped values belonging to the same metric and the same set of labeled dimensions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scraping-metrics-with-pushprox">Scraping Metrics with PushProx<a class="hash-link" href="#scraping-metrics-with-pushprox" title="Direct link to heading">​</a></h3><p>Certain internal Kubernetes components are scraped via a proxy deployed as part of Monitoring V2 called PushProx. For detailed information on PushProx, refer <a href="#how-pushprox-works">here</a> and to the above <a href="#1-architecture-overview">architecture</a> section.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scraping-metrics">Scraping Metrics<a class="hash-link" href="#scraping-metrics" title="Direct link to heading">​</a></h3><p>The following Kubernetes components are directly scraped by Prometheus:</p><ul><li>kubelet*</li><li>ingress-nginx**</li><li>coreDns/kubeDns</li><li>kube-api-server</li></ul><p>*<!-- --> You can optionally use <code>hardenedKubelet.enabled</code> to use a PushProx, but that is not the default.</p><p>** For RKE and RKE2 clusters, ingress-nginx is deployed by default and treated as an internal Kubernetes component.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scraping-metrics-based-on-kubernetes-distribution">Scraping Metrics Based on Kubernetes Distribution<a class="hash-link" href="#scraping-metrics-based-on-kubernetes-distribution" title="Direct link to heading">​</a></h3><p>Metrics are scraped differently based on the Kubernetes distribution. For help with terminology, refer <a href="#terminology">here</a>. For details, see the table below:</p><figcaption>How Metrics are Exposed to Prometheus</figcaption><table><thead><tr><th>Kubernetes Component</th><th>RKE</th><th>RKE2</th><th>KubeADM</th><th>K3s</th></tr></thead><tbody><tr><td>kube-controller-manager</td><td>rkeControllerManager.enabled</td><td>rke2ControllerManager.enabled</td><td>kubeAdmControllerManager.enabled</td><td>k3sServer.enabled</td></tr><tr><td>kube-scheduler</td><td>rkeScheduler.enabled</td><td>rke2Scheduler.enabled</td><td>kubeAdmScheduler.enabled</td><td>k3sServer.enabled</td></tr><tr><td>etcd</td><td>rkeEtcd.enabled</td><td>rke2Etcd.enabled</td><td>kubeAdmEtcd.enabled</td><td>Not available</td></tr><tr><td>kube-proxy</td><td>rkeProxy.enabled</td><td>rke2Proxy.enabled</td><td>kubeAdmProxy.enabled</td><td>k3sServer.enabled</td></tr><tr><td>kubelet</td><td>Collects metrics directly exposed by kubelet</td><td>Collects metrics directly exposed by kubelet</td><td>Collects metrics directly exposed by kubelet</td><td>Collects metrics directly exposed by kubelet</td></tr><tr><td>ingress-nginx*</td><td>Collects metrics directly exposed by kubelet, exposed by rkeIngressNginx.enabled</td><td>Collects metrics directly exposed by kubelet, Exposed by rke2IngressNginx.enabled</td><td>Not available</td><td>Not available</td></tr><tr><td>coreDns/kubeDns</td><td>Collects metrics directly exposed by coreDns/kubeDns</td><td>Collects metrics directly exposed by coreDns/kubeDns</td><td>Collects metrics directly exposed by coreDns/kubeDns</td><td>Collects metrics directly exposed by coreDns/kubeDns</td></tr><tr><td>kube-api-server</td><td>Collects metrics directly exposed by kube-api-server</td><td>Collects metrics directly exposed by kube-api-server</td><td>Collects metrics directly exposed by kube-appi-server</td><td>Collects metrics directly exposed by kube-api-server</td></tr></tbody></table><p>*<!-- --> For RKE and RKE2 clusters, ingress-nginx is deployed by default and treated as an internal Kubernetes component.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="terminology">Terminology<a class="hash-link" href="#terminology" title="Direct link to heading">​</a></h3><ul><li><strong>kube-scheduler:</strong> The internal Kubernetes component that uses information in the pod spec to decide on which node to run a pod.</li><li><strong>kube-controller-manager:</strong> The internal Kubernetes component that is responsible for node management (detecting if a node fails), pod replication and endpoint creation.</li><li><strong>etcd:</strong> The internal Kubernetes component that is the distributed key/value store which Kubernetes uses for persistent storage of all cluster information.</li><li><strong>kube-proxy:</strong> The internal Kubernetes component that watches the API server for pods/services changes in order to maintain the network up to date.</li><li><strong>kubelet:</strong> The internal Kubernetes component that watches the API server for pods on a node and makes sure they are running.</li><li><strong>ingress-nginx:</strong> An Ingress controller for Kubernetes using NGINX as a reverse proxy and load balancer.</li><li><strong>coreDns/kubeDns:</strong> The internal Kubernetes component responsible for DNS.</li><li><strong>kube-api-server:</strong> The main internal Kubernetes component that is responsible for exposing APIs for the other master components.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/rancher/rancher-docs/edit/main/versioned_docs/version-2.5/explanations/integrations-in-rancher/monitoring-and-alerting/how-monitoring-works.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-09-10T07:31:45.000Z">9/10/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/v2.5/pages-for-subheaders/monitoring-and-alerting"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Monitoring and Alerting</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/v2.5/explanations/integrations-in-rancher/monitoring-and-alerting/rbac-for-monitoring"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Role-based Access Control</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-architecture-overview" class="table-of-contents__link toc-highlight">1. Architecture Overview</a><ul><li><a href="#prometheus-operator" class="table-of-contents__link toc-highlight">Prometheus Operator</a></li><li><a href="#servicemonitors-and-podmonitors" class="table-of-contents__link toc-highlight">ServiceMonitors and PodMonitors</a></li><li><a href="#how-pushprox-works" class="table-of-contents__link toc-highlight">How PushProx Works</a></li><li><a href="#prometheusrules" class="table-of-contents__link toc-highlight">PrometheusRules</a></li><li><a href="#alert-routing" class="table-of-contents__link toc-highlight">Alert Routing</a></li></ul></li><li><a href="#2-how-prometheus-works" class="table-of-contents__link toc-highlight">2. How Prometheus Works</a><ul><li><a href="#storing-time-series-data" class="table-of-contents__link toc-highlight">Storing Time Series Data</a></li><li><a href="#defining-rules-for-prometheus" class="table-of-contents__link toc-highlight">Defining Rules for Prometheus</a></li><li><a href="#alerting-and-recording-rules" class="table-of-contents__link toc-highlight">Alerting and Recording Rules</a></li></ul></li><li><a href="#3-how-alertmanager-works" class="table-of-contents__link toc-highlight">3. How Alertmanager Works</a><ul><li><a href="#alerts-forwarded-by-alertingdrivers" class="table-of-contents__link toc-highlight">Alerts Forwarded by alertingDrivers</a></li><li><a href="#routing-alerts-to-receivers" class="table-of-contents__link toc-highlight">Routing Alerts to Receivers</a></li><li><a href="#configuring-multiple-receivers" class="table-of-contents__link toc-highlight">Configuring Multiple Receivers</a></li></ul></li><li><a href="#4-monitoring-v2-specific-components" class="table-of-contents__link toc-highlight">4. Monitoring V2 Specific Components</a><ul><li><a href="#resources-deployed-by-default" class="table-of-contents__link toc-highlight">Resources Deployed by Default</a></li><li><a href="#default-exporters" class="table-of-contents__link toc-highlight">Default Exporters</a></li><li><a href="#components-exposed-in-the-rancher-ui" class="table-of-contents__link toc-highlight">Components Exposed in the Rancher UI</a></li><li><a href="#pushprox" class="table-of-contents__link toc-highlight">PushProx</a></li></ul></li><li><a href="#5-scraping-and-exposing-metrics" class="table-of-contents__link toc-highlight">5. Scraping and Exposing Metrics</a><ul><li><a href="#defining-what-metrics-are-scraped" class="table-of-contents__link toc-highlight">Defining what Metrics are Scraped</a></li><li><a href="#how-the-prometheus-operator-sets-up-metrics-scraping" class="table-of-contents__link toc-highlight">How the Prometheus Operator Sets up Metrics Scraping</a></li><li><a href="#how-kubernetes-component-metrics-are-exposed" class="table-of-contents__link toc-highlight">How Kubernetes Component Metrics are Exposed</a></li><li><a href="#scraping-metrics-with-pushprox" class="table-of-contents__link toc-highlight">Scraping Metrics with PushProx</a></li><li><a href="#scraping-metrics" class="table-of-contents__link toc-highlight">Scraping Metrics</a></li><li><a href="#scraping-metrics-based-on-kubernetes-distribution" class="table-of-contents__link toc-highlight">Scraping Metrics Based on Kubernetes Distribution</a></li><li><a href="#terminology" class="table-of-contents__link toc-highlight">Terminology</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 SUSE Rancher. All Rights Reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d2604d48.js"></script>
<script src="/assets/js/main.aa78001f.js"></script>
</body>
</html>