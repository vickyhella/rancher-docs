"use strict";(self.webpackChunkrancher_docs=self.webpackChunkrancher_docs||[]).push([[58662],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>h});var r=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},o=Object.keys(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=r.createContext({}),c=function(e){var t=r.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=c(a),h=n,d=m["".concat(l,".").concat(h)]||m[h]||u[h]||o;return a?r.createElement(d,i(i({ref:t},p),{},{components:a})):r.createElement(d,i({ref:t},p))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:n,i[1]=s;for(var c=2;c<o;c++)i[c]=a[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}m.displayName="MDXCreateElement"},76730:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var r=a(87462),n=(a(67294),a(3905));const o={title:"Migrating Rancher to a New Cluster"},i=void 0,s={unversionedId:"how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/migrate-rancher-to-new-cluster",id:"how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/migrate-rancher-to-new-cluster",title:"Migrating Rancher to a New Cluster",description:"If you are migrating Rancher to a new Kubernetes cluster, you don't need to install Rancher on the new cluster first. If Rancher is restored to a new cluster with Rancher already installed, it can cause problems.",source:"@site/docs/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/migrate-rancher-to-new-cluster.md",sourceDirName:"how-to-guides/new-user-guides/backup-restore-and-disaster-recovery",slug:"/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/migrate-rancher-to-new-cluster",permalink:"/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/migrate-rancher-to-new-cluster",draft:!1,editUrl:"https://github.com/rancher/rancher-docs/edit/main/docs/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/migrate-rancher-to-new-cluster.md",tags:[],version:"current",lastUpdatedAt:1666730466,formattedLastUpdatedAt:"Oct 25, 2022",frontMatter:{title:"Migrating Rancher to a New Cluster"},sidebar:"tutorialSidebar",previous:{title:"Restoring Rancher",permalink:"/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/restore-rancher"},next:{title:"Backing up Rancher Installed with Docker",permalink:"/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/back-up-docker-installed-rancher"}},l={},c=[{value:"Prerequisites",id:"prerequisites",level:3},{value:"1. Install the rancher-backup Helm chart",id:"1-install-the-rancher-backup-helm-chart",level:3},{value:"2. Restore from backup using a Restore custom resource",id:"2-restore-from-backup-using-a-restore-custom-resource",level:3},{value:"3. Install cert-manager",id:"3-install-cert-manager",level:3},{value:"4. Bring up Rancher with Helm",id:"4-bring-up-rancher-with-helm",level:3}],p={toc:c};function u(e){let{components:t,...a}=e;return(0,n.kt)("wrapper",(0,r.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"If you are migrating Rancher to a new Kubernetes cluster, you don't need to install Rancher on the new cluster first. If Rancher is restored to a new cluster with Rancher already installed, it can cause problems."),(0,n.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,n.kt)("p",null,"These instructions assume you have ",(0,n.kt)("a",{parentName:"p",href:"/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/back-up-rancher"},"created a backup")," and you have already installed a new Kubernetes cluster where Rancher will be deployed."),(0,n.kt)("admonition",{type:"caution"},(0,n.kt)("p",{parentName:"admonition"},"It is required to use the same hostname that was set as the server URL in the first cluster. If not done, downstream clusters will show as unavailable in the cluster management page of the UI, and you won't be able to click inside the cluster or on the cluster's ",(0,n.kt)("b",null,"Explore")," button.")),(0,n.kt)("p",null,"Rancher version must be v2.5.0 and up"),(0,n.kt)("p",null,"Rancher can be installed on any Kubernetes cluster, including hosted Kubernetes clusters such as Amazon EKS clusters. For help installing Kubernetes, refer to the documentation of the Kubernetes distribution. One of Rancher's Kubernetes distributions may also be used:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://rancher.com/docs/rke/latest/en/installation/"},"RKE Kubernetes installation docs")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://rancher.com/docs/k3s/latest/en/installation/"},"K3s Kubernetes installation docs"))),(0,n.kt)("h3",{id:"1-install-the-rancher-backup-helm-chart"},"1. Install the rancher-backup Helm chart"),(0,n.kt)("p",null,"Install the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/rancher/backup-restore-operator/tags"},"rancher-backup chart"),", using a version in the 2.x.x major version range:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Add the helm repository:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo add rancher-charts https://charts.rancher.io\nhelm repo update\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Select and set ",(0,n.kt)("inlineCode",{parentName:"p"},"CHART_VERSION")," variable with a 2.x.x rancher-backup release version:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"helm search repo --versions rancher-charts/rancher-backup\nCHART_VERSION=<2.x.x>\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Install the charts:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"helm install rancher-backup-crd rancher-charts/rancher-backup-crd -n cattle-resources-system --create-namespace --version $CHART_VERSION\nhelm install rancher-backup rancher-charts/rancher-backup -n cattle-resources-system --version $CHART_VERSION\n")),(0,n.kt)("admonition",{parentName:"li",type:"note"},(0,n.kt)("p",{parentName:"admonition"},"The above assumes an environment with outbound connectivity to Docker Hub"),(0,n.kt)("p",{parentName:"admonition"},"For an ",(0,n.kt)("strong",{parentName:"p"},"air-gapped environment"),", use the Helm value below to pull the ",(0,n.kt)("inlineCode",{parentName:"p"},"backup-restore-operator")," image from your private registry when installing the rancher-backup Helm chart."),(0,n.kt)("pre",{parentName:"admonition"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"--set image.repository $REGISTRY/rancher/backup-restore-operator\n"))))),(0,n.kt)("h3",{id:"2-restore-from-backup-using-a-restore-custom-resource"},"2. Restore from backup using a Restore custom resource"),(0,n.kt)("admonition",{title:"Important:",type:"note"},(0,n.kt)("p",{parentName:"admonition"},"Kubernetes v1.22, available as an experimental feature of v2.6.3, does not support restoring from backup files containing CRDs with the apiVersion ",(0,n.kt)("inlineCode",{parentName:"p"},"apiextensions.k8s.io/v1beta1"),". In v1.22, the default ",(0,n.kt)("inlineCode",{parentName:"p"},"resourceSet")," in the rancher-backup app is updated to collect only CRDs that use ",(0,n.kt)("inlineCode",{parentName:"p"},"apiextensions.k8s.io/v1"),". There are currently two ways to work around this issue:"),(0,n.kt)("ol",{parentName:"admonition"},(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Update the default ",(0,n.kt)("inlineCode",{parentName:"p"},"resourceSet")," to collect the CRDs with the apiVersion v1.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Update the default ",(0,n.kt)("inlineCode",{parentName:"p"},"resourceSet")," and the client to use the new APIs internally, with ",(0,n.kt)("inlineCode",{parentName:"p"},"apiextensions.k8s.io/v1")," as the replacement."),(0,n.kt)("admonition",{parentName:"li",type:"note"},(0,n.kt)("p",{parentName:"admonition"},"When making or restoring backups for v1.22, the Rancher version and the local cluster's Kubernetes version should be the same. The Kubernetes version should be considered when restoring a backup since the supported apiVersion in the cluster and in the backup file could be different."))))),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"When using S3 object storage as the backup source for a restore that requires credentials, create a ",(0,n.kt)("inlineCode",{parentName:"p"},"Secret")," object in this cluster to add the S3 credentials. The secret data must have two keys - ",(0,n.kt)("inlineCode",{parentName:"p"},"accessKey"),", and ",(0,n.kt)("inlineCode",{parentName:"p"},"secretKey"),", that contain the S3 credentials."),(0,n.kt)("p",{parentName:"li"},"The secret can be created in any namespace, this example uses the default namespace."),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create secret generic s3-creds \\\n  --from-literal=accessKey=<access key> \\\n  --from-literal=secretKey=<secret key>\n")),(0,n.kt)("admonition",{parentName:"li",type:"note"},(0,n.kt)("p",{parentName:"admonition"},"Add your access key and secret key as values for ",(0,n.kt)("inlineCode",{parentName:"p"},"accessKey")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"secretKey")," in the command above."))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Create a ",(0,n.kt)("inlineCode",{parentName:"p"},"Restore")," object:"),(0,n.kt)("p",{parentName:"li"},"During a migration, ",(0,n.kt)("inlineCode",{parentName:"p"},"prune")," must be set to ",(0,n.kt)("inlineCode",{parentName:"p"},"false"),". See the example below:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"# restore-migration.yaml\napiVersion: resources.cattle.io/v1\nkind: Restore\nmetadata:\n  name: restore-migration\nspec:\n  backupFilename: backup-b0450532-cee1-4aa1-a881-f5f48a007b1c-2020-09-15T07-27-09Z.tar.gz\n  // highlight-next-line\n  prune: false\n  // highlight-next-line\n  encryptionConfigSecretName: encryptionconfig\n  storageLocation:\n    s3:\n      credentialSecretName: s3-creds\n      credentialSecretNamespace: default\n      bucketName: backup-test\n      folder: ecm1\n      region: us-west-2\n      endpoint: s3.us-west-2.amazonaws.com\n")),(0,n.kt)("admonition",{parentName:"li",title:"Important",type:"note"},(0,n.kt)("p",{parentName:"admonition"},"The field ",(0,n.kt)("inlineCode",{parentName:"p"},"encryptionConfigSecretName")," should be used only if your backup was created with encryption enabled."),(0,n.kt)("p",{parentName:"admonition"},"If this applies, provide the name of the ",(0,n.kt)("inlineCode",{parentName:"p"},"Secret")," object containing the encryption config file. If you only have the encryption config file, but don't have the secret created in this cluster, use the following steps to create the secret:"),(0,n.kt)("ol",{parentName:"admonition"},(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Create an ",(0,n.kt)("a",{parentName:"p",href:"/reference-guides/backup-restore-configuration/backup-configuration#encryption"},"encryption configuration file"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"The command below uses a file named ",(0,n.kt)("inlineCode",{parentName:"p"},"encryption-provider-config.yaml"),", with the ",(0,n.kt)("inlineCode",{parentName:"p"},"--from-file")," flag. Run the below once the ",(0,n.kt)("inlineCode",{parentName:"p"},"EncryptionConfiguration")," is saved in a file called ",(0,n.kt)("inlineCode",{parentName:"p"},"encryption-provider-config.yaml"),":"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create secret generic encryptionconfig \\\n  --from-file=./encryption-provider-config.yaml \\\n  -n cattle-resources-system\n")))))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Apply the manifest, and monitor the Restore status:"),(0,n.kt)("ol",{parentName:"li"},(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Apply the ",(0,n.kt)("inlineCode",{parentName:"p"},"Restore")," object resource:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f restore-migration.yaml\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Watch the Restore status:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get restore\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Watch the restoration logs:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl logs -n cattle-resources-system --tail 100 -f -l app.kubernetes.io/instance=rancher-backup\n"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Once the Restore resource has the status ",(0,n.kt)("inlineCode",{parentName:"p"},"Completed"),", you can continue the cert-manager and Rancher installation."))))),(0,n.kt)("h3",{id:"3-install-cert-manager"},"3. Install cert-manager"),(0,n.kt)("p",null,"Follow the steps to ",(0,n.kt)("a",{parentName:"p",href:"/pages-for-subheaders/install-upgrade-on-a-kubernetes-cluster#4-install-cert-manager"},"install cert-manager")," in the documentation about installing cert-manager on Kubernetes."),(0,n.kt)("h3",{id:"4-bring-up-rancher-with-helm"},"4. Bring up Rancher with Helm"),(0,n.kt)("p",null,"Use the same version of Helm to install Rancher, that was used on the first cluster."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"helm install rancher rancher-latest/rancher \\\n  --namespace cattle-system \\\n  --set hostname=<same hostname as the server URL from the first Rancher server> \\\n  --version x.y.z\n")),(0,n.kt)("admonition",{type:"note"},(0,n.kt)("p",{parentName:"admonition"},"If the original Rancher environment is running, you can collect the current values with a kubeconfig for the original environment:"),(0,n.kt)("pre",{parentName:"admonition"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"helm get values rancher -n cattle-system -o yaml > rancher-values.yaml\n")),(0,n.kt)("p",{parentName:"admonition"},"These values can be reused using the ",(0,n.kt)("inlineCode",{parentName:"p"},"rancher-values.yaml")," file. Be sure to switch the kubeconfig to the new Rancher environment."),(0,n.kt)("pre",{parentName:"admonition"},(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"helm install rancher rancher-latest/rancher -n cattle-system -f rancher-values.yaml --version x.y.z\n"))))}u.isMDXComponent=!0}}]);