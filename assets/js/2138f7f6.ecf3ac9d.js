"use strict";(self.webpackChunkrancher_docs=self.webpackChunkrancher_docs||[]).push([[69674],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>d});var n=r(67294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=n.createContext({}),c=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},u=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),h=c(r),d=a,m=h["".concat(l,".").concat(d)]||h[d]||p[d]||o;return r?n.createElement(m,s(s({ref:t},u),{},{components:r})):n.createElement(m,s({ref:t},u))}));function d(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,s=new Array(o);s[0]=h;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:a,s[1]=i;for(var c=2;c<o;c++)s[c]=r[c];return n.createElement.apply(null,s)}return n.createElement.apply(null,r)}h.displayName="MDXCreateElement"},62444:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var n=r(87462),a=(r(67294),r(3905));const o={title:"Tips for Scaling Rancher"},s=void 0,i={unversionedId:"reference-guides/best-practices/rancher-server/tips-for-scaling-rancher",id:"reference-guides/best-practices/rancher-server/tips-for-scaling-rancher",title:"Tips for Scaling Rancher",description:"This guide aims to introduce the approaches that should be considered to scale Rancher setups, and associated challenges with doing so. As systems grow performance will naturally reduce, but there are steps we can take to minimize the load put on Rancher, as well as optimize Rancher's ability to handle these larger setups.",source:"@site/docs/reference-guides/best-practices/rancher-server/tips-for-scaling-rancher.md",sourceDirName:"reference-guides/best-practices/rancher-server",slug:"/reference-guides/best-practices/rancher-server/tips-for-scaling-rancher",permalink:"/reference-guides/best-practices/rancher-server/tips-for-scaling-rancher",draft:!1,editUrl:"https://github.com/rancher/rancher-docs/edit/main/docs/reference-guides/best-practices/rancher-server/tips-for-scaling-rancher.md",tags:[],version:"current",lastUpdatedAt:1670963511,formattedLastUpdatedAt:"Dec 13, 2022",frontMatter:{title:"Tips for Scaling Rancher"}},l={},c=[{value:"General Tips on Optimizing Rancher&#39;s Performance",id:"general-tips-on-optimizing-ranchers-performance",level:2},{value:"Minimizing Load on the local cluster",id:"minimizing-load-on-the-local-cluster",level:2},{value:"Managing Your Object Counts",id:"managing-your-object-counts",level:3},{value:"Using New Apps Over Legacy Apps",id:"using-new-apps-over-legacy-apps",level:3},{value:"Using the Authorized Cluster Endpoint (ACE)",id:"using-the-authorized-cluster-endpoint-ace",level:3},{value:"Experimental: Option to Reduce Event Handler Executions",id:"experimental-option-to-reduce-event-handler-executions",level:3},{value:"Optimizations Outside of Rancher",id:"optimizations-outside-of-rancher",level:2},{value:"Keeping Kubernetes Versions Up to Date",id:"keeping-kubernetes-versions-up-to-date",level:3},{value:"Optimizing ETCD",id:"optimizing-etcd",level:3}],u={toc:c};function p(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"This guide aims to introduce the approaches that should be considered to scale Rancher setups, and associated challenges with doing so. As systems grow performance will naturally reduce, but there are steps we can take to minimize the load put on Rancher, as well as optimize Rancher's ability to handle these larger setups."),(0,a.kt)("h2",{id:"general-tips-on-optimizing-ranchers-performance"},"General Tips on Optimizing Rancher's Performance"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"It is advisable to keep Rancher up to date with patch releases. Performance improvements and bug fixes are made throughout the life of a minor release. You can review the release notes to help inform your own decisions on whether an upgrade is necessary but we recommend keeping yourself up to date in most cases.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Performance will be negatively impacted by increased latency between Rancher's infrastructure and a downstream cluster's infrastructure (eg. geographic distance). If a user or organization requires clusters/nodes all over the world or spread across many regions, it is best to use multiple Rancher installations.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Please always try to scale up gradually, monitoring and observing any change in behavior while doing do. It is usually easier to resolve performance problems as soon as they surface, and before other problems confuse symptoms. "))),(0,a.kt)("h2",{id:"minimizing-load-on-the-local-cluster"},"Minimizing Load on the local cluster"),(0,a.kt)("p",null,"The largest bottleneck when scaling Rancher is resource growth in the local Kubernetes cluster. The local cluster contains information for all downstream clusters. Many operations that apply to downstream clusters will create new objects in the local cluster and require computation from handlers running in the local cluster."),(0,a.kt)("h3",{id:"managing-your-object-counts"},"Managing Your Object Counts"),(0,a.kt)("p",null,"ETCD eventually encounters limitations to the number of a single Kubernetes resource type it can store. These exact numbers are not well documented. From internal observations we usually see performance issues once a single resource type's object count exceeds 60k, and often that type is Rolebindings."),(0,a.kt)("p",null,"Rolebindings are created in the local cluster as a side effect of many operations."),(0,a.kt)("p",null,"Considerations when attempting reduce rolebindings in the local cluster:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Only add users to clusters and projects when necessary"),(0,a.kt)("li",{parentName:"ul"},"Remove clusters and projects when they are no longer needed"),(0,a.kt)("li",{parentName:"ul"},"Only use custom roles if necessary"),(0,a.kt)("li",{parentName:"ul"},"Use as few rules as possible in custom roles"),(0,a.kt)("li",{parentName:"ul"},"Consider whether adding a role to a user is redundant"),(0,a.kt)("li",{parentName:"ul"},"Consider that using less, but more powerful, clusters may be more efficient"),(0,a.kt)("li",{parentName:"ul"},"Experiment to see if creating new projects or creating new clusters manifests in fewer rolebindings for your specific use case.")),(0,a.kt)("h3",{id:"using-new-apps-over-legacy-apps"},"Using New Apps Over Legacy Apps"),(0,a.kt)("p",null,"There are two app kubernetes resources that Rancher uses: apps.projects.cattle.io and apps.cattle.cattle.io. The legacy apps, apps.projects.cattle.io, were introduced first in the Cluster Manager and are now outdated. The new apps, apps.catalog.cattle.io, are found in the Cluster Explorer for their respective cluster. The new apps are preferrable because they live in the downstream cluster while the legacy apps live in the local cluster."),(0,a.kt)("p",null,"We recommend removing apps that appear in the Cluster Manager, replacing them with apps in the Cluster Explorer for their target cluster if necessary and creating any future apps in the cluster's Cluster Explorer only."),(0,a.kt)("h3",{id:"using-the-authorized-cluster-endpoint-ace"},"Using the Authorized Cluster Endpoint (ACE)"),(0,a.kt)("p",null,"There is an ",(0,a.kt)("em",{parentName:"p"},"Authorized Cluster Endpoint")," option for Rancher provisioned RKE1, RKE2, and K3s clusters. When enabled this adds a context to kubeconfigs generated for the cluster that uses a direct endpoint to the cluster and bypasses Rancher. However, it is not enough to only enable this option. The user of the Kubeconfig needs to use ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl use-context <ace context name>")," in order to start using it."),(0,a.kt)("p",null,"Without using ACE, all kubeconfig requests first route through Rancher."),(0,a.kt)("h3",{id:"experimental-option-to-reduce-event-handler-executions"},"Experimental: Option to Reduce Event Handler Executions"),(0,a.kt)("p",null,"The bulk of Rancher's logic occurs on event handlers. These event handlers run on an object whenever the object is updated, and when Rancher is started. Additionally, they run every 15 hours when caches are synced. In scaled setups these scheduled runs come with huge performance costs because every handler is being run on every applicable object. However, this scheduled execution of handlers can be disabled using the CATTLE_SYNC_ONLY_CHANGED_OBJECTS environment variable. If resource allocation spikes are seen on an interval of about 15 hours it is possible this setting can help."),(0,a.kt)("p",null,"The value for the environment variable can be a comma separated list of the following options. The values refer to types of controllers (the structures that contain and run handlers) and their handlers. Adding the controller types to the variable will disable that set of controllers from running their handlers as part of cache resyncing."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mgmt")," refers to management controllers which only run on one Rancher node."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"user")," refers to user controllers which run for every cluster. Some of these are ran on the same node as management controllers, while other run in the downstream cluster. This will option targets the former."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"scaled")," refers to scaled controllers which run on every Rancher node. This is not recommended to be set due to the critical functionality the scaled handlers are responsible for.")),(0,a.kt)("p",null,"In short, if you notice CPU usage peaks every 15 hours, add the CATTLE_SYNC_ONLY_CHANGED_OBJECTS environment variable to your rancher deployment with the value ",(0,a.kt)("inlineCode",{parentName:"p"},"mgmt,user"),"."),(0,a.kt)("h2",{id:"optimizations-outside-of-rancher"},"Optimizations Outside of Rancher"),(0,a.kt)("p",null,'A large component of performance is the local cluster and how it was configured. This cluster can introduce a bottleneck before Rancher software ever runs. When Rancher nodes experience high resource usage, you can use the command "top" to identify whether it is Rancher or a Kubernetes component that is consuming the resource in excess.'),(0,a.kt)("h3",{id:"keeping-kubernetes-versions-up-to-date"},"Keeping Kubernetes Versions Up to Date"),(0,a.kt)("p",null,"Similar to Rancher versions, it is advisable to keep your kubernetes cluster up to date. This will ensure that your cluster contains any available performance enhancements or bug fixes."),(0,a.kt)("h3",{id:"optimizing-etcd"},"Optimizing ETCD"),(0,a.kt)("p",null,"The two main bottlenecks to ",(0,a.kt)("a",{parentName:"p",href:"https://etcd.io/docs/v3.4/op-guide/performance/"},"ETCD performance")," are disk speed and network speed. Optimization to either should improve performance. For information regarding ETCD performance see ",(0,a.kt)("a",{parentName:"p",href:"https://www.suse.com/support/kb/doc/?id=000020100"},"Slow etcd performance (performance testing and optimization)")," and ",(0,a.kt)("a",{parentName:"p",href:"https://docs.ranchermanager.rancher.io/how-to-guides/advanced-user-guides/tune-etcd-for-large-installs"},"Tuning etcd for Large Installations"),". Information on disks can also be found ",(0,a.kt)("a",{parentName:"p",href:"https://docs.Ranchermanager.Rancher.io/v2.5/pages-for-subheaders/installation-requirements#disks"},"in our docs"),"."),(0,a.kt)("p",null,"Theoretically, the more nodes in an ETCD cluster the slower it will be due to replication requirements ",(0,a.kt)("a",{parentName:"p",href:"https://etcd.io/docs/v3.3/faq"},"source"),". This may be counter-intuitive to common scaling approaches. It can also be inferred that ETCD performance will be inversely affected by distance between nodes as that will slow down network communication."))}p.isMDXComponent=!0}}]);